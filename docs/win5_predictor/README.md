# JRA Win5 予想ソフト

## 概要

JRA(日本中央競馬会)のWin5(毎週日曜の指定5レースの1着馬を全て的中させる馬券)を、Pythonの機械学習を用いて自動予想するシステムです。

### Win5とは？
- **対象**: 毎週日曜日に指定された5レース（通常は複数の競馬場のメインレース）
- **勝率**: 全5レースの1着馬を正確に予想する必要がある
- **最低購入**: 100円/組み合わせ
- **配当**: パリミューチュエル方式（回収率は通常100%以下）

## 目標

1. **高精度な勝馬予測**: 機械学習モデル（LightGBM）で各レースの勝率を予測
2. **最適な買い目生成**: 予算制約下でWin5の最適な組み合わせを自動決定
3. **期待値分析**: オッズとの比較で、エッジのあるベットを発見
4. **資金管理**: Kelly基準に基づく賭金管理とバックテスト検証

## システム要件

- Python 3.10以上
- Windows/macOS/Linux

## 技術スタック

| 領域 | ツール |
|------|--------|
| ML | LightGBM, scikit-learn, Optuna |
| データ | pandas, numpy, SQLite |
| スクレイピング | requests, BeautifulSoup4 |
| 可視化 | matplotlib, plotly |
| CLI | click, rich |
| ダッシュボード | Streamlit |

## プロジェクト構成

```
win5_predictor/
├── src/
│   ├── config/          # 設定・定数
│   ├── scraper/         # Webスクレイピング
│   ├── database/        # SQLiteデータベース
│   ├── features/        # 特徴量エンジニアリング
│   ├── model/           # LightGBMモデル
│   ├── optimizer/       # Win5最適化
│   ├── bankroll/        # 資金管理
│   ├── analysis/        # バックテスト・分析
│   └── app/             # CLIとダッシュボード
├── data/                # データベース・キャッシュ
├── models/              # 学習済みモデル
├── notebooks/           # Jupyter分析
├── tests/               # テストコード
└── pyproject.toml       # 依存パッケージ定義
```

## 使用するデータソース

- **netkeiba.com**: レース結果、出馬表、馬情報、騎手・調教師情報、オッズ
- **JRA公式**: Win5対象レース情報

## 主要な特徴量（約80-120個）

| カテゴリ | 例 |
|---------|-----|
| 馬の近走成績 | 勝率、複勝率、平均着順、連勝数 |
| 馬のスピード | スピード指数、上がり3F、距離ベストタイム |
| 馬の適性 | 距離別・馬場別・競馬場別勝率 |
| 騎手・調教師 | 勝率、相性パラメータ |
| レース環境 | 場の強さ、ペース予測、枠順バイアス |
| オッズ | 単勝オッズ、暗示確率、人気順位 |
| 血統 | 父系の馬場・距離別勝率 |

## 予測アルゴリズム

1. **時系列交差検証**: Walk-forward validationで未来データのリークを防止
2. **二値分類**: 各馬について1着確率を予測（target: 1着=1, その他=0）
3. **確率キャリブレーション**: 各レース内で合計≈1.0に正規化
4. **期待値検出**: (モデル予測確率 - オッズ暗示確率) でエッジを発見

## Win5最適化ロジック

### 予算最適化
- 5レース各々から何頭ずつ選ぶかを決定
- 全有効割当: n₁ × n₂ × n₃ × n₄ × n₅ ≤ 予算÷100
- 的中確率を最大化する最適な配置を検索

### 期待値計算
```
EV = P(全5レース正解) × 推定配当 - 購入金額
```

### 資金管理（Kelly基準）
```
推奨賭金 = 資金 × (1/4) × ((配当×確率) - 1) / (配当 - 1)
```
※ 1/4 Kelly(quarter Kelly)を推奨（リスク軽減）

## 実装フェーズ

1. **基盤構築**: DB設定・基本モジュール設計
2. **データ収集**: netkeiba.comからのスクレイピング実装
3. **特徴量エンジニアリング**: 80-120個の特徴量計算
4. **機械学習**: LightGBMモデル学習・最適化
5. **Win5最適化**: 買い目自動生成・期待値計算
6. **分析**: バックテスト・回収率分析・資金管理
7. **アプリケーション**: CLI・Streamlitダッシュボード

## クイックスタート

```bash
# 1. 依存パッケージインストール
pip install -e ".[dev]"

# 2. 過去データ収集（初回のみ、50時間程度）
win5 collect --start 2015-01-01 --end 2025-12-31

# 3. モデル学習
win5 train --start 2015-01-01 --end 2024-12-31

# 4. Win5予想（毎週日曜朝）
win5 predict --date 2026-02-15 --budget 10000

# 5. 過去データでバックテスト
win5 backtest --start 2023-01-01 --end 2025-12-31

# 6. Webダッシュボード起動
win5 dashboard
```

## CLIコマンド一覧

| コマンド | 説明 |
|---------|------|
| `win5 collect` | netkeiba.comからデータ収集 |
| `win5 train` | 予測モデル学習 |
| `win5 predict` | Win5予想生成 |
| `win5 backtest` | 過去データでシミュレーション |
| `win5 status` | システム状態確認 |
| `win5 dashboard` | Streamlitダッシュボード起動 |

## 実装計画

詳細な実装計画は [IMPLEMENTATION_PLAN.md](./IMPLEMENTATION_PLAN.md) を参照してください。

### 開発スケジュール
- **Phase 1-2**: データ基盤構築・収集（週1-2）
- **Phase 3-4**: 特徴量・ML モデル（週2-3）
- **Phase 5-6**: Win5最適化・分析（週1-2）
- **Phase 7**: アプリケーション層（週1-2）

**総期間**: 約7-8週間（並行作業を含む）

## 注意事項

⚠️ **重要な制限事項**

1. **netkeiba.com利用規約**: スクレイピングは1秒以上の間隔を空ける必要があります
2. **初回データ収集**: 2015年からの全レース情報取得には50時間以上かかります（キャッシュにより再実行は高速）
3. **Win5の特性**: 30%の控除率があるため、回収率100%超を達成するにはモデルのエッジが不可欠
4. **リアルマネー**: このシステムは教育的な目的で開発されています。実際の賭けには十分な検証とリスク管理が必要です

## ファイル構成

このディレクトリ:
- `README.md` - このファイル（概要説明）
- `IMPLEMENTATION_PLAN.md` - 詳細な実装計画書
- `ARCHITECTURE.md` - システムアーキテクチャ（準備中）
- `DATASET_SCHEMA.md` - データベーススキーマ詳細（準備中）

## ライセンス

このプロジェクトはEducational purposesのため開発されています。

## 参考リソース

- [netkeiba.com](https://netkeiba.com/) - 競馬データベース
- [JRA公式](https://www.jra.go.jp/) - 日本中央競馬会
- [LightGBM documentation](https://lightgbm.readthedocs.io/)
- [Optuna documentation](https://optuna.readthedocs.io/)

---

**更新日**: 2026年2月14日
**ステータス**: 計画フェーズ（Phase 1開始準備中）
