# 特徴重要度解析レポート — 予測精度改善ポイント

## 実行日
2026年2月14日

## 概要
LightGBMモデルの特徴重要度分析により、以下の主要な発見を得ました：

### 💡 主な発見

#### 1. **最重要特徴の特定**
以下の4つの特徴が全体の約42%の予測力を占めています：

| 順位 | 特徴名 | 1着モデル重要度 | 2着モデル重要度 | 解釈 |
|------|--------|--------|--------|------|
| 1 | **jockey_horse_pair_wins** | 1226 (14.4%) | 1122 (14.1%) | 騎手と馬のペア成績 — 同じコンビでの過去成績が最強の予測要因 |
| 2 | **horse_days_since_last** | 867 (24.6%) | 763 (23.7%) | 馬の休国日数 — 調教期間からの復帰タイミングが重要 |
| 3 | **horse_last3_avg_finish** | 773 (33.7%) | 704 (32.6%) | 直近3レース平均順位 — 最近の安定性が指標 |
| 4 | **horse_same_venue_win_rate** | 738 (42.4%) | 677 (41.1%) | 同一馬場での勝率 — 馬場適性が大きく影響 |

#### 2. **モデルの効率性**
- **1着モデル**: 9特徴で80%の予測力（全17特徴中 52.9%削減可能）
- **2着モデル**: 10特徴で80%の予測力（全17特徴中 58.8%削減可能）

#### 3. **普遍的な予測パターン**
上位10特徴が両モデルで**完全に同じ**（ランクは若干異なるがほぼ同一順）
→ 1着予測と2着予測のロジックが本質的に同じであることを示唆

---

## 改善提案（優先度順）

### ⭐ **優先度1: 特徴エンジニアリング** — 予測精度向上（期待度：高）

最重要特徴の**相互作用項**を追加することで、複雑な意思決定パターンをキャプチャ

#### 提案する相互作用項：

```
1. jockey_horse_pair_wins × horse_same_venue_win_rate
   → 特定馬場でのペアの相性度
   
2. horse_last5_win_rate × distance
   → 得意な距離での勝率（距離適性の確認）
   
3. horse_speed_index_last1 × field_size
   → 相手のレベルを考慮した馬の実力度
   
4. horse_days_since_last × race_number_in_sequence
   → 長期休暇後の復帰レース位置の影響
```

#### 利点：
- 既存データでの追加学習（新データ取得不要）
- LightGBMの深い木構造で自動学習可能
- 計算コスト低い（特に相互作用項の数が少ない場合）

---

### ⭐⭐ **優先度2: 低重要度特徴の削除 & 再学習** — 効率化＆過学習低減

下位25%の特徴（jockey_win_rate_venue, track_cond_enc, popularity_rank など）を削除

#### 期待効果：
- **計算時間**: 約15-20%削減
- **モデル複雑度**: 5特徴削減で学習時間短縮
- **汎化性能**: オーバーフィッティング低減により未知データでの精度向上見込み
- **保守性**: 特徴セットの簡素化

#### 実装手順：
```python
# builder.py の NUMERIC_FEATURES を以下に変更
NUMERIC_FEATURES = [
    "horse_last1_finish",
    "horse_last3_avg_finish",
    "horse_last5_win_rate",
    "horse_career_win_rate",
    "horse_days_since_last",           # 重要度2位
    "horse_same_venue_win_rate",       # 重要度4位
    "horse_same_dist_win_rate",        # 重要度6位
    "horse_speed_index_last1",         # 重要度7位
    "jockey_horse_pair_wins",          # 重要度1位
    "field_size",                      # 重要度5位
    "distance",                        # 重要度15位
    "gate_number",                     # 重要度9位
    "weight_carried",
    "horse_weight",
    # ↓ 削除候補（下位25%）
    # "jockey_win_rate_venue",
    # "track_cond_enc",
    # "popularity_rank",
    # "horse_weight_change",
]
```

---

### ⭐⭐ **優先度3: データ品質向上** — 学習精度改善

最重要特徴の欠損を削減することで学習サンプルを増加

#### 重点改善対象：

1. **jockey_horse_pair_wins の欠損削減**
   - 現状: 騎手と馬の過去コンビのローカルマッチング
   - 改善: より長期の履歴を参照（1-2年分など）
   
2. **horse_last5_win_rate の完全性強化**
   - 現状: 過去5レースの勝率（レースが足りない場合は欠損）
   - 改善: 過去10レース以内のレース数に応じた加重平均
   
3. **horse_speed_index の計算堅牢化**
   - 現状: finish_time が欠落すると計算不可
   - 改善: 代替指標（着差時間など）での補完

#### 期待効果：
- 学習サンプル数の増加（欠損削減で5-10%増加見込み）
- モデルの統計的有意性向上
- より安定した予測

---

### ⭐⭐ **優先度4: モデル/戦略調整** — ROI改善

#### 4-1. 高重要度特徴フィルタの導入

```python
# 特定条件を満たすレースのみ賭けの絞り込み
conditions = {
    "jockey_horse_pair_wins": lambda x: x > x.quantile(0.6),  # 上位40%
    "horse_days_since_last": lambda x: (x > 20) & (x < 120),  # 適度な休国
    "horse_same_venue_win_rate": lambda x: x > 0.35,           # 馬場適性あり
}
```

効果: 賭け対象を50%に削減 → 的中率向上の可能性（ROI -45% → -20% 目標）

#### 4-2. 複合式（WINs/複勝など）への切り替え

- 現在: 馬単（exact correcta）を賭与— 2頭を指定順で予測
- 変更案: Win/複勝で買いを増やす
  - 的中率は上げやすい
  - 払戻倍率は低いが確実性が高い

---

### 🔮 **優先度5: 実験的な取組** — 中長期的な改善

#### 5-1. 高重要度特徴に特化した簡易モデル

```python
# 最上位3特徴だけで学習：
simple_features = [
    "jockey_horse_pair_wins",
    "horse_days_since_last", 
    "horse_last3_avg_finish",
]
```

目的: 複雑モデルとの精度比較 / 解釈可能性向上

#### 5-2. アンサンブル学習

- LightGBM + XGBoost + CatBoost を結合
- スタッキング: メタ予測器で統合
- 期待: 単一モデルより汎化性能向上（-5~10% ROI改善）

#### 5-3. テンポラル検証（Time Series Split）の強化

- 現在: 5-fold TimeSeriesSplit
- 改善: より長期の学習期間でテスト、定期的なモデル再学習

---

## 実装優先スケジュール

```
【Phase 1 - 即座（1-2日）】
  ✓ 優先度1: 相互作用項の追加
  ✓ 優先度2: 低重要度特徴削除 & 再学習
    → 合計所要時間: 学習 ~30分

【Phase 2 - 短期（1週間）】
  → 優先度3: データ品質向上
    （scaper の改修が必要）
  → 優先度4: 部分的な条件フィルタ導入

【Phase 3 - 中期（2-4週間）】
  → 優先度4: 複合式への戦略転換
  → 優先度5: 実験的モデル開発
```

---

## 定量的な期待効果

| 項目 | 現在値 | 目標値 | 達成時期 |
|------|-------|-------|---------|
| ROI | -45.9% | -20% | Phase 1完了後（1週間） |
| 的中数 | 5 / 413 | 10 / 350 | Phase 2完了後（2週間） |
| 計算時間 | 100% | 80-85% | Phase 1完了後 |
| 汎化性能 | 既知データ CV 79.9% | >82% | Phase 2完了後 |

---

## 次のアクション

1. **相互作用項を追加した新バージョンの builder.py を作成**
2. **低重要度特徴を除去 & 再学習**
3. **新モデルでバックテスト実行**
4. **改善前後の ROI 比較**

---

**生成日**: 2026年2月14日  
**分析対象**: nankan_v1 モデル（2023-01-01 〜 2026-02-12 学習, 413レース評価）  
**著者**: AI Code Assistant
