#!/usr/bin/env python3
"""トリプル馬単 2026年実データに基づく買い目分析。

2026年の実績データ（35日開催・105レース）を基に、
人気・オッズの傾向を分析し、最適な購入戦略を提案する。

Usage:
    python scripts/triple_exacta_realdata_analysis.py
"""

# ============================================================
#  2026年 実績データ（35日開催 = 105レース）
# ============================================================

TOTAL_DAYS = 35
TOTAL_RACES = 105  # 35日 × 3レッグ

# --- 人気別1着データ ---
# 1,2番人気が1着になった回数: 71回 (67.6%)
FAV12_WIN_COUNT = 71
# レッグ別内訳: Leg1=24回, Leg2=25回, Leg3=22回 ≈ 各2/3
FAV12_WIN_BY_LEG = [24, 25, 22]
# 非人気馬(3番人気以降)が1着の回数: Leg1=9, Leg2=14, Leg3=9 → 計32回
NON_FAV_WIN_BY_LEG = [9, 14, 9]  # ≈ 各1/3
NON_FAV_WIN_COUNT = sum(NON_FAV_WIN_BY_LEG)  # ≈ 34

# --- 1-2人気の馬単組み合わせ ---
# 1→2 or 2→1の馬単的中: 35回/105レース (33.3%)
FAV12_EXACTA_COUNT = 35
FAV12_EXACTA_AVG_PAYOUT = 584  # 平均配当(100円あたり推定)
# そのうち14回は 2→1 (裏目)
FAV12_EXACTA_REVERSE = 14
FAV12_EXACTA_DIRECT = FAV12_EXACTA_COUNT - FAV12_EXACTA_REVERSE  # 21回

# --- 非人気馬が1着のときの2着傾向 ---
# 3番人気以降が1着のとき、1,2番人気が2着に来る回数: 15回
# (非人気馬1着の約47%)
NON_FAV_WIN_FAV_SECOND = 15

# --- 全レッグ人気決着の日 ---
# 3レッグとも1,2番人気が1着で決まった日: 11日 (31.4%)
DAYS_ALL_FAV_WIN = 11

# --- 1-2人気馬単が全く来ない日 ---
# 1日3レッグのうち1-2人気の馬単組み合わせ(1→2 or 2→1)が来る日: 14日 (40%)
# → 来ない日: 21日 (60%)
DAYS_WITH_FAV_EXACTA = 14
DAYS_WITHOUT_FAV_EXACTA = TOTAL_DAYS - DAYS_WITH_FAV_EXACTA

# --- 非人気1着の人気帯 ---
# 1,2番人気以外が1着のときは3〜9番人気 (10,11番人気が1着のときは相手が1番人気)
# → 1着が荒れても3〜9番人気の範囲が中心


def pct(n, total):
    return n / total * 100


def fmt(amount):
    if amount >= 100_000_000:
        return f"{amount / 100_000_000:.2f}億円"
    if amount >= 10_000:
        return f"{amount / 10_000:.1f}万円"
    return f"{amount:,.0f}円"


def main():
    print("=" * 80)
    print("トリプル馬単 2026年実データ分析 (35日開催 / 105レース)")
    print("=" * 80)

    # ============================================================
    # 1. 基本統計
    # ============================================================
    print("\n" + "─" * 80)
    print("■ 1. 基本統計")
    print("─" * 80)

    print(f"""
  全開催日数: {TOTAL_DAYS}日
  全レース数: {TOTAL_RACES}レース (3レッグ/日)

  ┌─────────────────────────────────────────────────────────┐
  │ 1,2番人気が1着になる確率:                                │
  │   {FAV12_WIN_COUNT}/{TOTAL_RACES} = {pct(FAV12_WIN_COUNT, TOTAL_RACES):.1f}% (約2/3)       │
  │   Leg別: {FAV12_WIN_BY_LEG[0]}/{TOTAL_DAYS} | {FAV12_WIN_BY_LEG[1]}/{TOTAL_DAYS} | {FAV12_WIN_BY_LEG[2]}/{TOTAL_DAYS}                               │
  │                                                         │
  │ 3番人気以降が1着になる確率:                                │
  │   {NON_FAV_WIN_COUNT}/{TOTAL_RACES} = {pct(NON_FAV_WIN_COUNT, TOTAL_RACES):.1f}% (約1/3)     │
  │   Leg別: {NON_FAV_WIN_BY_LEG[0]}/{TOTAL_DAYS} | {NON_FAV_WIN_BY_LEG[1]}/{TOTAL_DAYS} | {NON_FAV_WIN_BY_LEG[2]}/{TOTAL_DAYS}                              │
  │                                                         │
  │ 1→2 or 2→1 馬単:                                       │
  │   {FAV12_EXACTA_COUNT}/{TOTAL_RACES} = {pct(FAV12_EXACTA_COUNT, TOTAL_RACES):.1f}% (3レースに1回)   │
  │   うち 1→2: {FAV12_EXACTA_DIRECT}回 / 2→1: {FAV12_EXACTA_REVERSE}回                       │
  │                                                         │
  │ 全3レッグとも1,2人気が1着の日:                            │
  │   {DAYS_ALL_FAV_WIN}/{TOTAL_DAYS}日 = {pct(DAYS_ALL_FAV_WIN, TOTAL_DAYS):.1f}% (約3日に1日)      │
  │                                                         │
  │ 1,2人気以外の1着の人気帯: 3〜9番人気が中心                 │
  │ (10-11番人気→1番人気の組み合わせも出現)                    │
  └─────────────────────────────────────────────────────────┘
""")

    # ============================================================
    # 2. 日単位の分析（トリプル馬単の的中に直結）
    # ============================================================
    print("─" * 80)
    print("■ 2. 日単位の分析（3レッグ全体での傾向）")
    print("─" * 80)

    # 1日3レッグの内訳パターン
    # 1,2人気が1着になる確率 ≈ 2/3 なので:
    # 3レッグとも1-2人気勝ち: (2/3)^3 ≈ 29.6%
    # 2レッグが1-2人気勝ち: C(3,2) * (2/3)^2 * (1/3) ≈ 44.4%
    # 1レッグが1-2人気勝ち: C(3,1) * (2/3) * (1/3)^2 ≈ 22.2%
    # 0レッグが1-2人気勝ち: (1/3)^3 ≈ 3.7%

    p_fav = FAV12_WIN_COUNT / TOTAL_RACES  # 0.676

    # 理論値計算
    p_all3 = p_fav ** 3
    p_2of3 = 3 * (p_fav ** 2) * (1 - p_fav)
    p_1of3 = 3 * p_fav * ((1 - p_fav) ** 2)
    p_0of3 = (1 - p_fav) ** 3

    print(f"""
  【1日3レッグのうち、1-2番人気が1着になるレッグ数の分布】

  パターン         理論値      推定日数    実績      含意
  ──────────────────────────────────────────────────────────────────
  3レッグとも堅い    {p_all3*100:5.1f}%      {p_all3*TOTAL_DAYS:.0f}日     {DAYS_ALL_FAV_WIN}日      堅い日 → 低配当
  2レッグ堅い       {p_2of3*100:5.1f}%      {p_2of3*TOTAL_DAYS:.0f}日              ★最頻パターン
  1レッグ堅い       {p_1of3*100:5.1f}%      {p_1of3*TOTAL_DAYS:.0f}日              荒れ気味の日
  全レッグ荒れ      {p_0of3*100:5.1f}%      {p_0of3*TOTAL_DAYS:.0f}日              超高配当 or 不的中

  ※実績11日 vs 理論値{p_all3*TOTAL_DAYS:.0f}日 → 理論通り。データの信頼性が高い
""")

    print(f"""
  【重要な発見】
  ・1→2 or 2→1 馬単が来る日: {DAYS_WITH_FAV_EXACTA}日/{TOTAL_DAYS}日 = {pct(DAYS_WITH_FAV_EXACTA, TOTAL_DAYS):.0f}%
  ・来ない日: {DAYS_WITHOUT_FAV_EXACTA}日/{TOTAL_DAYS}日 = {pct(DAYS_WITHOUT_FAV_EXACTA, TOTAL_DAYS):.0f}%

  → 6割の日は「1-2人気の馬単組み合わせ」が3レッグのどこにも来ない！
  → 1→2, 2→1 だけに絞ると6割の日は不的中が確定する
""")

    # ============================================================
    # 3. 2着の傾向分析
    # ============================================================
    print("─" * 80)
    print("■ 3. 1着と2着の組み合わせ傾向")
    print("─" * 80)

    # 非人気1着 × 人気2着
    non_fav_total = NON_FAV_WIN_COUNT  # 34回
    non_fav_fav_2nd = NON_FAV_WIN_FAV_SECOND  # 15回
    non_fav_non_2nd = non_fav_total - non_fav_fav_2nd

    print(f"""
  【1着が1-2番人気のとき (71回)】
   ・2着も1-2番人気: {FAV12_EXACTA_COUNT}回 ({pct(FAV12_EXACTA_COUNT, FAV12_WIN_COUNT):.0f}%)
     → 1-2人気が1着のうち約半分は2着も1-2人気
   ・2着が3番人気以降: {FAV12_WIN_COUNT - FAV12_EXACTA_COUNT}回 ({pct(FAV12_WIN_COUNT - FAV12_EXACTA_COUNT, FAV12_WIN_COUNT):.0f}%)
     → もう半分は相手(2着)が3番人気以降

  【1着が3番人気以降のとき ({non_fav_total}回)】
   ・2着が1-2番人気: {non_fav_fav_2nd}回 ({pct(non_fav_fav_2nd, non_fav_total):.0f}%)
     → 荒れた時でも約半分は1-2番人気が2着に残る
   ・2着も3番人気以降: {non_fav_non_2nd}回 ({pct(non_fav_non_2nd, non_fav_total):.0f}%)
     → 1着も2着も荒れるケースは約半分

  【非人気1着の人気帯】
   ・1,2番人気以外が1着の場合、主に 3〜9番人気 が中心
   ・10-11番人気が1着のとき → 2着は1番人気が来やすい
   → 裏目買い「10→1」「11→1」は検討に値する
""")

    # ============================================================
    # 4. トリプル馬単 買い目組み立ての核心
    # ============================================================
    print("─" * 80)
    print("■ 4. 実データから導く「核心的な買い目パターン」")
    print("─" * 80)

    # 各レッグの1着パターン確率
    # A: 1-2人気が1着 (67.6%) → 「堅パターン」
    # B: 3-9人気が1着 (約27%) → 「中穴パターン」
    # C: 10番人気以降が1着 (約5%) → 「大穴パターン」
    # ※実データでは1,2人気以外の1着は3〜9番人気が中心

    p_a = FAV12_WIN_COUNT / TOTAL_RACES  # 0.676
    p_b = 0.27  # 3-9番人気が中心
    p_c = 1 - p_a - p_b  # 残り ≈ 5%

    patterns = [
        ("AAA (3レッグとも堅い)", p_a**3, f"低配当 (実績{DAYS_ALL_FAV_WIN}日)"),
        ("AAB (2堅 + 1中穴)", 3 * p_a**2 * p_b, "中配当 ★最頻パターン"),
        ("AAC (2堅 + 1大穴)", 3 * p_a**2 * p_c, "高配当"),
        ("ABB (1堅 + 2中穴)", 3 * p_a * p_b**2, "高配当"),
        ("ABC (堅+中穴+大穴)", 6 * p_a * p_b * p_c, "超高配当"),
        ("BBB (3中穴)", p_b**3, "超高配当"),
        ("その他 (大穴含む)", 1 - (p_a**3 + 3*p_a**2*p_b + 3*p_a**2*p_c + 3*p_a*p_b**2 + 6*p_a*p_b*p_c + p_b**3), "大穴配当"),
    ]

    print(f"""
  【3レッグの1着人気パターン別 発生確率】
  (A=1,2人気, B=3-9人気, C=10番人気以降)

  {'パターン':<30} {'確率':>8} {'35日中':>8} {'配当傾向':>14}
  {'─'*70}""")
    for name, prob, desc in patterns:
        days = prob * TOTAL_DAYS
        print(f"  {name:<30} {prob*100:>6.1f}%  {days:>5.1f}日  {desc}")

    # ============================================================
    # 5. 具体的な推奨買い方
    # ============================================================
    print("\n" + "─" * 80)
    print("■ 5. 実データに基づく推奨買い方")
    print("─" * 80)

    print("""
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  推奨パターン1: 2レッグ堅め + 1レッグ幅広 (★最推奨)
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  【根拠】
  ・AABパターン（2堅+1中穴）が最頻 → 約30%の確率
  ・「堅レッグ」: 1-2人気が1着の確率67.6% → 2レッグ中2レッグ堅い確率 約46%
  ・「荒れレッグ」: 3-9人気が1着 + 2着は1-2人気が47%

  【堅レッグの買い方】(2レッグ分)
   1着: 1番人気, 2番人気
   2着: 1番人気, 2番人気, 3番人気
   → 各レッグ 4通り (1→2, 1→3, 2→1, 2→3)

  【荒れレッグの買い方】(1レッグ分)
   1着: 1-7番人気 (3-9番人気中心だが1-2番人気も入れる)
   2着: 1-3番人気 (荒れたときも1-2番人気が2着に47%)
   → 18通り

  合計: 4 × 4 × 18 = 288点 = 14,400円

  ★予算に合わせた絞り方:
   予算1,000円 → 堅Leg: 2通り × 2通り × 荒Leg: 5通り = 20点 = 1,000円
   予算3,000円 → 堅Leg: 3通り × 3通り × 荒Leg: 7通り ≈ 63点 = 3,150円
   予算5,000円 → 堅Leg: 4通り × 4通り × 荒Leg: 6通り = 96点 = 4,800円

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  推奨パターン2: 全レッグ「人気+裏目」型
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  【根拠】
  ・非人気馬が1着のとき、1-2番人気が2着に来る確率47%
  ・つまり「人気馬の裏目（2着）」を買うことが重要
  ・10-11番人気→1番人気の組み合わせが実際に出ている

  【各レッグ共通の買い方】
   正目: 1→2, 1→3, 2→1, 2→3         (4通り)
   裏目: 3→1, 4→1, 5→1, 6→1, 7→1    (5通り)
   → 各レッグ 9通り

  合計: 9 × 9 × 9 = 729点 = 36,450円 (フル)

  ★予算に合わせた絞り方:
   各レッグ5通りに絞る: 5 × 5 × 5 = 125点 = 6,250円
   各レッグ4通りに絞る: 4 × 4 × 4 = 64点 = 3,200円
   各レッグ3通りに絞る: 3 × 3 × 3 = 27点 = 1,350円

  ★どの3通りを選ぶか（最重要）:
   案A (堅め): 1→2, 2→1, 3→1
   案B (攻め): 1→3, 2→1, 5→1
   → レッグごとに堅め/攻めを使い分ける
""")

    # ============================================================
    # 6. 10-11番人気の扱い（中穴→大穴の境界）
    # ============================================================
    print("─" * 80)
    print("■ 6. 10-11番人気の扱いと大穴対策")
    print("─" * 80)

    print(f"""
  【実データの発見】
  ・1,2番人気以外が1着のときは「3〜9番人気」が中心
  ・10-11番人気が1着のとき → 2着は1番人気が来やすい
  ・つまり「10→1」「11→1」は有力な裏目パターン

  【10-11番人気の扱い方】
  ・全レッグに入れると点数が爆発する → 非現実的
  ・荒れそうな1レッグだけに「10→1」「11→1」を追加する

  【推奨】
  ・堅レッグ: 3〜7番人気の裏目まで（X→1, X→2）
  ・荒レッグ: 3〜9番人気 + 余裕があれば10-11番人気→1番人気を追加
  ・さらに保険として「一部ランダム」でカバーするのが効率的

  【ポイント: なぜ「X→1」が重要か】
  ・荒れたとき（3番人気以降が1着）でも47%は1,2番人気が2着
  ・特に大穴（10-11番人気）ほど相手は1番人気に集中する傾向
  ・つまり「穴馬→1番人気」は最もコスパの良い裏目
""")

    # ============================================================
    # 7. 数値で見る最適配分
    # ============================================================
    print("─" * 80)
    print("■ 7. 実データベースの推奨買い目（予算別）")
    print("─" * 80)

    strategies = [
        {
            "budget": 1000,
            "name": "予算1,000円 (20点)",
            "legs": [
                {"label": "堅Leg1", "combos": ["1→2", "2→1"], "count": 2},
                {"label": "堅Leg2", "combos": ["1→2", "2→1"], "count": 2},
                {"label": "荒Leg3", "combos": ["1→3", "2→3", "3→1", "4→1", "5→1"], "count": 5},
            ],
        },
        {
            "budget": 2000,
            "name": "予算2,000円 (40点)",
            "legs": [
                {"label": "堅Leg1", "combos": ["1→2", "1→3", "2→1", "2→3"], "count": 4},
                {"label": "堅Leg2", "combos": ["1→2", "2→1"], "count": 2},
                {"label": "荒Leg3", "combos": ["1→3", "2→3", "3→1", "4→1", "5→1"], "count": 5},
            ],
        },
        {
            "budget": 3000,
            "name": "予算3,000円 (60点)",
            "legs": [
                {"label": "堅Leg1", "combos": ["1→2", "1→3", "2→1", "2→3"], "count": 4},
                {"label": "堅Leg2", "combos": ["1→2", "1→3", "2→1"], "count": 3},
                {"label": "荒Leg3", "combos": ["1→3", "2→3", "3→1", "4→1", "5→1"], "count": 5},
            ],
        },
        {
            "budget": 5000,
            "name": "予算5,000円 (100点)",
            "legs": [
                {"label": "堅Leg1", "combos": ["1→2", "1→3", "2→1", "2→3"], "count": 4},
                {"label": "堅Leg2", "combos": ["1→2", "1→3", "2→1", "2→3"], "count": 4},
                {"label": "荒Leg3", "combos": ["3→1", "4→1", "5→1", "6→1", "7→1", "3→2"], "count": 6},
            ],
        },
        {
            "budget": 10000,
            "name": "予算10,000円 (200点)",
            "legs": [
                {
                    "label": "堅Leg1",
                    "combos": ["1→2", "1→3", "2→1", "2→3", "3→1"],
                    "count": 5,
                },
                {
                    "label": "堅Leg2",
                    "combos": ["1→2", "1→3", "2→1", "2→3", "3→1"],
                    "count": 5,
                },
                {
                    "label": "荒Leg3",
                    "combos": [
                        "1→3", "2→3", "3→1", "3→2",
                        "4→1", "5→1", "6→1", "7→1",
                    ],
                    "count": 8,
                },
            ],
        },
    ]

    for s in strategies:
        total_points = 1
        for leg in s["legs"]:
            total_points *= leg["count"]
        cost = total_points * 50
        remaining = s["budget"] - cost

        print(f"\n  ▼ {s['name']}")
        print(f"    実際の購入点数: {total_points}点 = {fmt(cost)}")
        if remaining >= 0:
            print(f"    余り: {fmt(remaining)} → ランダムに追加投入推奨")
        else:
            print(f"    ※予算超過 {fmt(-remaining)}: 荒Legを1通り減らして調整")

        for leg in s["legs"]:
            combos_str = ", ".join(leg["combos"])
            print(f"    {leg['label']}: [{combos_str}] ({leg['count']}通り)")

    # ============================================================
    # 8. 最重要ポイントまとめ
    # ============================================================
    print("\n" + "=" * 80)
    print("■ 最重要ポイント（2026年実データからの結論）")
    print("=" * 80)

    print("""
  ┌──────────────────────────────────────────────────────────────┐
  │                                                              │
  │ 1. 1-2人気だけの馬単(1→2, 2→1)に絞ると6割の日は全滅する      │
  │    → 必ず3番人気以降の「裏目」(X→1, X→2)を入れること         │
  │                                                              │
  │ 2. 最頻パターンは「2レッグ堅い + 1レッグ荒れ」(約30%)         │
  │    → 2レッグを人気で固め、1レッグを手広く買うのが最効率         │
  │                                                              │
  │ 3. 荒れたとき（3番人気以降が1着）でも、                        │
  │    2着は1-2番人気が47%の確率で来る                             │
  │    → 「X→1」「X→2」(裏目)は必須の買い目                      │
  │                                                              │
  │ 4. 非人気1着は主に3〜9番人気帯                                │
  │    → 荒レッグの1着候補は3-7番人気で十分                       │
  │      (10番人気以降はランダム枠でカバー)                        │
  │                                                              │
  │ 5. 全3レッグが人気決着の日は11/35日 = 31%しかない              │
  │    → 7割の日で少なくとも1レッグは荒れる                       │
  │    → 「荒レッグ」の買い目カバーが的中の鍵                      │
  │                                                              │
  │ 6. キャリーオーバー時は投資額を2-3倍に増やす                   │
  │    → CO時のみ期待値がプラスになる可能性がある                  │
  │                                                              │
  │ 【買い目の基本形】                                            │
  │  堅Leg: 1→2, 1→3, 2→1, 2→3 の4通り                        │
  │  荒Leg: 3→1, 4→1, 5→1, 6→1, 7→1 + 2→3 の6通り           │
  │  → 4 × 4 × 6 = 96点 = 4,800円                              │
  │                                                              │
  └──────────────────────────────────────────────────────────────┘
""")


if __name__ == "__main__":
    main()
